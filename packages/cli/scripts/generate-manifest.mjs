/**
 * To avoid installing `oclif` as a dependency, this file mimics
 * how the manifest is generated by @oclif/core.
 * @see https://github.com/oclif/oclif/blob/main/src/commands/manifest.ts#L76
 */

import path from 'node:path';
import {fileURLToPath} from 'node:url';
import {writeFile, access} from 'node:fs/promises';
import {Plugin} from '@oclif/core';

console.log('\n', 'Generating Oclif manifest...');

const cwd = fileURLToPath(new URL('..', import.meta.url));

if (
  !(await access(path.join(cwd, 'dist', 'commands', 'hydrogen'))
    .then(() => true)
    .catch(() => false))
) {
  throw new Error(
    '`dist/commands/hydrogen` directory not found. Please build the CLI project first.',
  );
}

const plugin = new Plugin({
  root: cwd,
  type: 'core',
  ignoreManifest: true,
  errorOnManifestCreate: true,
  respectNoCacheDefault: true,
});

await plugin.load(true);

// Oclif resolves commands in parallel, so the order is not guaranteed.
// Sort commands here alphabetically to avoid Git conflicts:
const {manifest} = plugin;
manifest.commands = Object.fromEntries(
  Object.entries(manifest.commands).sort(([commandA], [commandB]) =>
    commandA.localeCompare(commandB),
  ),
);

await writeFile(
  path.join(cwd, 'oclif.manifest.json'),
  JSON.stringify(manifest, null, 2),
);

console.log('', 'Oclif manifest generated.\n');
